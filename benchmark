#!/usr/bin/env nix-shell
#!nix-shell -i bash ./benchmark-shell.nix
set -euo pipefail

if ! command -v chromedriver &> /dev/null; then echo 'Could not find chromedriver in $PATH'; exit 1; fi;

BENCHMARK=js-framework-benchmark
PACKAGES=(webdriver-ts webdriver-ts-results vanillajs-keyed)
KRAUSEST_REFLEX_DOM=$BENCHMARK/reflex-dom-v0.4-keyed
DIST=$KRAUSEST_REFLEX_DOM/dist

git clone https://github.com/alexfmpe/js-framework-benchmark
cd $BENCHMARK
git checkout 40b5728a805c3eefd19ec537d050508134f16f44
npm install
for package in "${PACKAGES[@]}"; do
    cd $package
    npm install
    npm run build-prod
    cd ..
done
cd ..

mkdir -p $DIST
cp -Rf $(nix-build -A ghcjs.reflex-dom --no-out-link)/bin/krausest.jsexe/* $DIST
cd $BENCHMARK

npm start &
SERVER_PID=$!

cd webdriver-ts
npm run selenium -- --framework vanillajs-keyed reflex --count 1 --headless --chromeBinary "$(which chromium)" --chromeDriver "$(which chromedriver)"
npm run results
kill $SERVER_PID
rm -rf $BENCHMARK
